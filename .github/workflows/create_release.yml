name: release images

on: [push]
  
  
  jobs:
    build:
      name: push images
      runs-on: ubuntu-latest
      steps:
        - name: checkout code
          uses: actions/checkout@master

        - name: create images
          run: |
            echo "creating lite image"
            export IMG_URL="https://downloads.raspberrypi.org/raspbian_lite_latest"
            ./build.sh
            mv ./result/rasp-custom.img.gz ./raspibian-LITE-${{ github.ref }}.img.gz

        - name: create Release
            id: create_release
            uses: actions/create-release@v1
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
                tag_name: ${{ github.ref }}
                release_name: Release ${{ github.ref }}
                draft: false
                prerelease: false
        
        - name: upload lite image
            id: upload-release-asset 
            uses: actions/upload-release-asset@v1
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
                upload_url: ${{ steps.create_release.outputs.upload_url }}
                asset_path: ./raspibian-LITE-${{ github.ref }}.img.gz
                asset_name: raspibian-LITE-${{ github.ref }}.img.gz
                asset_content_type: application/zip