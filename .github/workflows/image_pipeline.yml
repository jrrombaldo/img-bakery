name: images pipeline

on: [push]
  
jobs:
    # docker_push:
    #     runs-on: ubuntu-latest
    #     env:
    #         IMG_NAME: "jrromb/img-bakery" 
    #         DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
    #         DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

    #     steps:
    #     - uses: actions/checkout@v1

    #     - name: Build Docker Image
    #       run: |
    #         IMG_TAG=$(date +'%Y%m%d-%H%M')
    #         echo "::set-env name=IMG_TAG::$IMG_TAG"
    #         cd ./docker
    #         docker build . --file Dockerfile --tag $IMG_NAME:$IMG_TAG
            
    #     - name: Push to Docker Registry
    #       run: |
    #         echo "this is the value [$IMG_TAG]"
    #         docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
    #         docker tag $IMG_NAME:$IMG_TAG $IMG_NAME:latest
    #         docker images
    #         docker push $IMG_NAME
    #         docker logout
    #         rm -rf ~/.docker/config.json
            
    #     # - name: Update DockerHub Description
    #     #   run: |
    #     #     wget https://raw.githubusercontent.com/jrrombaldo/containers/master/update_dockerhub_desc.sh
    #     #     chmod +x ./update_dockerhub_desc.sh
    #     #     ./update_dockerhub_desc.sh
    #     #   env:
    #     #     CONTAINER: ${IMG_NAME}
   
   
    build_image_lite:
        name: create and release images
        runs-on: ubuntu-latest
        env:
            VERSION: "RaspibianLITE"
            IMG_URL: "https://downloads.raspberrypi.org/raspbian_lite_latest"

        steps:
        - name: checkout code
          uses: actions/checkout@master

        - name: create images              
          run: |
            ./build.sh
            sudo mv ./result/img-bakery.img.gz ./${VERSION}.img.gz    
            
        - name: upload lite image
          uses: actions/upload-artifact@v1
          with:
            name: ${VERSION}
            path: ./${VERSION}.img.gz


    build_image_GUI:
      name: create and release images
      runs-on: ubuntu-latest
      env:
          VERSION: "RaspibianGUI"
          IMG_URL: "https://downloads.raspberrypi.org/raspbian_latest"

      steps:
      - name: checkout code
        uses: actions/checkout@master

      - name: create images              
        run: |
          ./build.sh
          sudo mv ./result/img-bakery.img.gz ./${VERSION}.img.gz    
          
      - name: upload lite image
        uses: actions/upload-artifact@v1
        with:
          name: ${VERSION}
          path: ./${VERSION}.img.gz








    release_images:
      name: creating release for images
      runs-on: ubuntu-latest
      needs: [build_image_GUI, build_image_lite]
      
      steps:
        - name: download lite image
          uses: actions/download-artifact@v1
          with:
            name: RaspibianLITE

        - name: download full image
          uses: actions/download-artifact@v1
          with:
            name: RaspibianGUI

        - name: check files
          run: |
            ls -R

        # - name: create Release
        #   uses: actions/create-release@v1
        #   env:
        #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        #   with:
        #       tag_name: ${{ github.ref }}
        #       release_name: Release ${{ github.ref }}
        #       draft: false
        #       prerelease: false
        
        # - name: upload lite image
        #   uses: actions/upload-release-asset@v1
        #   env:
        #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        #   with:
        #       upload_url: ${{ steps.create_release.outputs.upload_url }}
        #       asset_path: ./${LITE_IMAGE}
        #       asset_name: .${LITE_IMAGE}
        #       asset_content_type: application/zip
        

                
